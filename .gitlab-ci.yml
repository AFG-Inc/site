image: python:3.6-alpine3.7

variables:
  PIPENV_VENV_IN_PROJECT: 1
  PIPENV_IGNORE_VIRTUALENVS: 1
  RABBITMQ_HOST: rabbit
  RETHINKDB_HOST: rethinkdb


before_script:
  - apk add --update tini
  - apk add --update git
  - apk add --update build-base
  - apk add --update gcc
  - apk add --update cmake
  - apk add --update autoconf
  - apk add --update automake
  - apk add --update libtool

stages:
  - test
  - deploy

test:
  tags:
  - docker

  stage: test
  services:
    - name: rabbitmq:3.7.5-alpine
      alias: rabbit

    - name: rethinkdb:2.3.6
      alias: rethinkdb

  cache:
    paths:
      - ".venv"
      - ".gem"

  script:
    - apk add --update ruby ruby-dev ruby-rdoc ruby-irb
    - pip install pipenv
    - pipenv sync --dev --three
    - gem install scss_lint
    - pipenv run lint
    - pipenv run lintscss
    - pipenv run python gunicorn_config.py
    - pipenv run test

deploy:
  tags:
  - docker

  only:
  - master

  services:
    - docker:dind

  stage: deploy
  script:
    - apk add docker curl
    - sh scripts/deploy.sh

  environment:
    name: Production
    url: https://pythondiscord.com